<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°åœŸçŸ³æ–¹è³‡æºå †ç½®è™•ç†å ´åˆ†å¸ƒåœ°åœ–</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-family: "Microsoft JhengHei", sans-serif;
        }

        .main-content {
            flex: 1;
        }

        header {
            background: white;
            border-bottom: 2px solid #eee;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        #map {
            height: 550px;
            width: 100%;
            border-radius: 12px;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #0d6efd;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .suspended-row {
            background-color: #fff5f5 !important;
            color: #b02a37;
        }

        footer {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px 0;
            text-align: center;
            border-top: 5px solid #0d6efd;
            margin-top: 40px;
        }

        .leaflet-popup-content {
            font-size: 0.92rem;
            line-height: 1.6;
            min-width: 260px;
        }
    </style>
</head>

<body>

    <header>
        <div class="container">
            <h1 class="fw-bold text-dark mb-0">å…¨è‡ºåœŸçŸ³æ–¹è³‡æºå †ç½®è™•ç†å ´åˆ†å¸ƒåœ°åœ–</h1>
        </div>
    </header>

    <div class="container main-content">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div><span class="text-muted small">æœ€å¾Œæ›´æ–°ï¼š<span id="update-text">å°šæœªåŸ·è¡Œ</span></span></div>
            <div class="btn-group shadow-sm">
                <button onclick="fetchAndUpdate()" id="btn-run" class="btn btn-primary px-4 fw-bold">ğŸ”„ æ›´æ–°æ•¸æ“š</button>
                <button onclick="downloadFiltered('excel')" class="btn btn-outline-primary px-3">ğŸ“¥ Excel</button>
                <button onclick="downloadFiltered('kml')" class="btn btn-outline-primary px-3">ğŸ“¥ KML</button>
                <button onclick="document.getElementById('kmlInput').click()" class="btn btn-outline-primary px-3">ğŸ“
                    ä¸Šå‚³ç¯„åœ KML</button>
                <input type="file" id="kmlInput" style="display: none;" accept=".kml" onchange="handleKmlUpload(event)">
                <a class="btn btn-outline-primary" href="https://www.soilmove.tw/" target="_blank"
                    rel="noopener noreferrer">ğŸŒ è³‡æ–™ä¾†æºï¼šç‡Ÿå»ºå‰©é¤˜åœŸçŸ³æ–¹è³‡è¨Šæœå‹™ä¸­å¿ƒ</a>
            </div>
        </div>

        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">ç¸£å¸‚ç¯©é¸</label>
                    <select id="f-city" class="form-select" onchange="applyFilters()">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-bold">å ´å€é¡å‹</label>
                    <select id="f-type" class="form-select" onchange="applyFilters()">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">ç‡Ÿé‹ç‹€æ…‹</label>
                    <select id="f-status" class="form-select" onchange="applyFilters()">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="active">ç‡Ÿé‹ä¸­ (è—æ¨™)</option>
                        <option value="suspended">æš«åœ/åœæ­¢ (é»‘æ¨™)</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end text-primary fw-bold pb-2" id="counter">å…± 0 ç­†</div>
            </div>
        </div>

        <div id="map" class="mb-4"></div>

        <div class="table-container shadow-sm bg-white rounded overflow-hidden mb-4"
            style="max-height: 400px; overflow-y: auto;">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>å ´å</th>
                        <th>ç¸£å¸‚</th>
                        <th>ç‹€æ…‹</th>
                        <th>å‰©é¤˜é‡(ã¥)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="data-list"></tbody>
            </table>
        </div>
    </div>

    <footer>
        <div class="container">Â© 2026 ä¸­èˆˆå·¥ç¨‹é¡§å•è‚¡ä»½æœ‰é™å…¬å¸åœ’è·¯éƒ¨ç¶­è­·ç®¡ç†</div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>

    <script>
        const map = L.map('map').setView([23.6, 120.9], 7);
        L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);

        let markerGroup = L.featureGroup().addTo(map);
        let rangeGroup = L.featureGroup().addTo(map);

        window.rawCache = [];

        const blackIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // --- ä¿®æ­£å¾Œçš„ KML ä¸Šå‚³é‚è¼¯ ---
        function handleKmlUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            window.kmlDone = false; // æ——æ¨™ç¢ºä¿åªè§¸ç™¼ä¸€æ¬¡

            reader.onload = function (e) {
                rangeGroup.clearLayers();
                const kmlText = e.target.result;

                // å»ºç«‹è§£æåœ–å±¤
                const runLayer = omnivore.kml.parse(kmlText);

                runLayer.setStyle({
                    color: "#0d6efd", weight: 4, fillColor: "#0d6efd", fillOpacity: 0.15
                });

                runLayer.addTo(rangeGroup);

                // ç¸®æ”¾å‡½å¼
                const finalizeKml = () => {
                    if (window.kmlDone) return;
                    const bounds = rangeGroup.getBounds();
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
                        alert("âœ… ç¯„åœä¸Šå‚³å®Œæˆï¼Œåœ°åœ–å°‡è‡ªå‹•ç¸®æ”¾ï¼");
                        window.kmlDone = true;
                    }
                };

                // ç›£è½ ready äº‹ä»¶ (é‡å°è¤‡é›œ KML)
                runLayer.on('ready', finalizeKml);

                // å®‰å…¨ç·©è¡ (é‡å°ç°¡å–® KML æˆ– ready äº‹ä»¶å¤±æ•ˆæ™‚)
                setTimeout(finalizeKml, 500);
            };

            reader.readAsText(file);
            event.target.value = ''; // æ¸…ç©º input è®“åŒæª”æ¡ˆå¯é‡è¤‡ä¸Šå‚³
        }

        async function fetchAndUpdate() {
            const btn = document.getElementById('btn-run');
            btn.disabled = true; btn.innerText = "è®€å–ä¸­...";
            try {
                const res = await fetch('/api/update');
                const result = await res.json();
                window.rawCache = result.data;
                document.getElementById('update-text').innerText = result.updated;

                const cities = [...new Set(window.rawCache.map(d => d.city))].filter(Boolean).sort();
                const types = [...new Set(window.rawCache.map(d => d.typename))].filter(Boolean).sort();
                document.getElementById('f-city').innerHTML = '<option value="">å…¨éƒ¨</option>' + cities.map(c => `<option value="${c}">${c}</option>`).join('');
                document.getElementById('f-type').innerHTML = '<option value="">å…¨éƒ¨</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');

                applyFilters();
            } catch (e) { alert("âŒ æ›´æ–°å¤±æ•—"); }
            finally { btn.disabled = false; btn.innerText = "ğŸ”„ æ›´æ–°æ•¸æ“š"; }
        }

        function applyFilters() {
            const cVal = document.getElementById('f-city').value;
            const tVal = document.getElementById('f-type').value;
            const sVal = document.getElementById('f-status').value;

            const filtered = window.rawCache.filter(item => {
                const matchC = !cVal || item.city === cVal;
                const matchT = !tVal || item.typename === tVal;
                const suspended = item.dumpname.includes("æš«åœ") || item.dumpname.includes("åœæ­¢") || item.dumpname.includes("åœå ´") || item.dumpname.includes("çµ‚æ­¢");
                const matchS = sVal === "all" || (sVal === "active" && !suspended) || (sVal === "suspended" && suspended);
                return matchC && matchT && matchS;
            });

            render(filtered);
        }

        function render(data) {
            markerGroup.clearLayers();
            const tbody = document.getElementById('data-list');
            tbody.innerHTML = '';
            document.getElementById('counter').innerText = `å…± ${data.length} ç­†`;

            data.forEach((d) => {
                const suspended = d.dumpname.includes("æš«åœ") || d.dumpname.includes("åœæ­¢") || d.dumpname.includes("åœå ´") || d.dumpname.includes("çµ‚æ­¢");
                const popupContent = `
                <strong>${d.dumpname}</strong><br/>
                <b>ç¸£å¸‚ï¼š</b> ${d.city}<br/>
                <b>é¡å‹ï¼š</b> ${d.typename}<br/>
                <b>æµå‘ç·¨è™Ÿï¼š</b> ${d.controlId}<br/>
                <b>ç”³å ±æ—¥æœŸï¼š</b> ${d.applydate}<br/><hr/>
                <b>B1~B7 å‰©é¤˜é‡ï¼š</b> ${d.remain} ã¥<br/>
                <b>B1~B7 æ ¸å‡†é‡ï¼š</b> ${d.maxbury} ã¥<br/>
                <b>é¢ç©ï¼š</b> ${d.area} å…¬é ƒ<hr/>
                <b>ç¶“åº¦ï¼š</b> ${d.lng}<br/><b>ç·¯åº¦ï¼š</b> ${d.lat}
            `;

                L.marker([d.lat, d.lng], { icon: suspended ? blackIcon : new L.Icon.Default() })
                    .addTo(markerGroup).bindPopup(popupContent);

                tbody.innerHTML += `
                <tr class="${suspended ? 'suspended-row' : ''}">
                    <td class="fw-bold">${d.dumpname}</td><td>${d.city}</td>
                    <td><span class="badge ${suspended ? 'bg-danger' : 'bg-success'}">${suspended ? 'æš«åœ' : 'ç‡Ÿé‹'}</span></td>
                    <td class="text-primary fw-bold">${d.remain}</td>
                    <td><button class="btn btn-sm btn-outline-primary" onclick="map.setView([${d.lat}, ${d.lng}], 15)">å®šä½</button></td>
                </tr>`;
            });

            // åƒ…åœ¨æ²’æœ‰ä¸Šå‚³ KML ä¸”æœ‰è³‡æ–™æ™‚è‡ªå‹•ç¸®æ”¾è‡³é»ä½
            if (data.length > 0 && rangeGroup.getLayers().length === 0) {
                map.fitBounds(markerGroup.getBounds());
            }
        }

        async function downloadFiltered(type) {
            // ... (çœç•¥èˆ‡ä¹‹å‰ä¸€è‡´çš„ fetch åŒ¯å‡ºé‚è¼¯) ...
            alert("æº–å‚™åŒ¯å‡º " + type.toUpperCase() + "...");
            // å‘¼å« API ä¸¦è™•ç† blob ä¸‹è¼‰
        }
    </script>
</body>

</html>