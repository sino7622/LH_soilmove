<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°åœŸçŸ³æ–¹è³‡æºåˆ†å¸ƒåœ°åœ–</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background-color: #f8f9fa;
            font-family: "Microsoft JhengHei", sans-serif;
        }

        header {
            background: white;
            border-bottom: 2px solid #eee;
            padding: 15px 0;
            margin-bottom: 20px;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #0d6efd;
        }

        .suspended-row {
            background-color: #fff5f5 !important;
            color: #b02a37;
        }

        footer {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px 0;
            text-align: center;
            margin-top: 30px;
        }

        /* è®“è¡¨æ ¼å…·å‚™å›æ‡‰å¼æ»¾å‹•ï¼ŒåŒæ™‚é™åˆ¶æœ€å¤§é«˜åº¦ */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
        }

        /* è¨­å®šè¡¨æ ¼åŸºæœ¬æ¨£å¼ */
        .table th,
        .table td {
            vertical-align: middle;
            padding: 12px 8px;
        }

        /* é—œéµï¼šè®“ç¬¬ä¸€æ¬„ï¼ˆå ´åï¼‰å¯ä»¥æ›è¡Œä¸¦é™åˆ¶å¯¬åº¦ */
        .table td:nth-child(1),
        .table th:nth-child(1) {
            white-space: normal !important;
            /* å…è¨±æ›è¡Œ */
            min-width: 180px;
            /* è¨­å®šæœ€å°å¯¬åº¦è§¸ç™¼æ›è¡Œ */
            max-width: 250px;
            word-break: break-all;
            /* é¿å…é•·è‹±æ–‡/æ•¸å­—æ’ç ´è¡¨æ ¼ */
        }

        /* å…¶ä»–æ¬„ä½å‰‡ä¿æŒä¸æ›è¡Œï¼Œä»¥ç¢ºä¿æ°´å¹³å»¶ä¼¸é¡¯ç¤ºå®Œæ•´è³‡è¨Š */
        .table td:not(:nth-child(1)),
        .table th:not(:nth-child(1)) {
            white-space: nowrap;
        }

        /* æ•¸å€¼æ¬„ä½å­—é«”ç¾åŒ–èˆ‡é å³å°é½Š */
        .text-end {
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
        }
    </style>
</head>

<body>

    <header>
        <div class="container">
            <h2 class="fw-bold mb-0">å…¨è‡ºåœŸçŸ³æ–¹è³‡æºå †ç½®è™•ç†å ´åœ°åœ–</h2>
        </div>
    </header>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div><span class="text-muted small">è³‡æ–™ç‹€æ…‹ï¼š<span id="update-text"
                        class="fw-bold text-primary">è®€å–ä¸­...</span></span></div>
            <div class="btn-group shadow-sm">
                <!-- <button onclick="fetchAndUpdate()" id="btn-run" class="btn btn-primary btn-sm px-3">ğŸ”„ æ›´æ–°æ•¸æ“š</button> -->

                <button onclick="document.getElementById('jsonDataInput').click()" class="btn btn-warning btn-sm">ğŸ“
                    æŠ½æ›é è¨­ JSON</button>

                <input type="file" id="jsonDataInput" style="display: none;" accept=".json"
                    onchange="uploadNewData(event)">


                <button onclick="downloadFiltered('excel')" class="btn btn-outline-primary btn-sm">ğŸ“¥ Excel</button>
                <button onclick="downloadFiltered('kml')" class="btn btn-outline-primary btn-sm">ğŸ“¥ KML</button>
                <button onclick="document.getElementById('kmlInput').click()" class="btn btn-outline-success btn-sm">ğŸ“
                    ä¸Šå‚³ç¯„åœ</button>
                <button onclick="zoomToKml()" class="btn btn-outline-success btn-sm">ğŸ¯ ç¸®æ”¾è‡³ç¯„åœ</button>
                <input type="file" id="kmlInput" style="display: none;" accept=".kml" onchange="handleKmlUpload(event)">
            </div>
        </div>

        <div class="filter-section shadow-sm">
            <div class="row g-3">
                <div class="col-md-3"><label class="form-label small fw-bold">ç¸£å¸‚</label><select id="f-city"
                        class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="">å…¨éƒ¨</option>
                    </select></div>
                <div class="col-md-4"><label class="form-label small fw-bold">é¡å‹</label><select id="f-type"
                        class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="">å…¨éƒ¨</option>
                    </select></div>
                <div class="col-md-3"><label class="form-label small fw-bold">ç‹€æ…‹</label><select id="f-status"
                        class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="active">ç‡Ÿé‹ä¸­</option>
                        <option value="suspended">æš«åœ/åœæ­¢</option>
                    </select></div>
                <div class="col-md-2 d-flex align-items-end text-primary fw-bold pb-1" id="counter">å…± 0 ç­†</div>
            </div>
        </div>

        <div id="map" class="mb-4"></div>

        <div class="table-responsive shadow-sm bg-white rounded" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-hover align-middle mb-0" style="min-width: 1200px;">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>å ´å</th>
                        <th>ç¸£å¸‚</th>
                        <th>é¡å‹</th>
                        <th>æµå‘ç·¨è™Ÿ</th>
                        <th>ç”³å ±æ—¥æœŸ</th>
                        <th>å‰©é¤˜é‡(ã¥)</th>
                        <th>æ ¸å‡†é‡(ã¥)</th>
                        <th>é¢ç©(ha)</th>
                        <th>ç‹€æ…‹</th>
                        <th>å®šä½</th>
                    </tr>
                </thead>
                <tbody id="data-list"></tbody>
            </table>
        </div>
    </div>

    <footer>
        <div class="container">Â© 2026 ä¸­èˆˆå·¥ç¨‹é¡§å•è‚¡ä»½æœ‰é™å…¬å¸åœ’è·¯éƒ¨</div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>

    <script>
        // --- 1. åˆå§‹åŒ–åœ°åœ–èˆ‡åº•åœ–æ§åˆ¶ ---
        const osm = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' });
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri Satellite'
        });

        const map = L.map('map', { center: [23.6, 120.9], zoom: 7, layers: [osm] });
        let markerGroup = L.featureGroup().addTo(map);
        let rangeGroup = L.featureGroup().addTo(map);

        // åœ–å±¤åˆ‡æ›é¸å–®
        L.control.layers({ "ğŸ—ºï¸ é›»å­åœ°åœ–": osm, "ğŸ›°ï¸ èˆªç…§åœ–å±¤": satellite }, { "ğŸ“ åœŸè³‡å ´": markerGroup, "ğŸ“ ç¯„åœå€": rangeGroup }).addTo(map);

        window.rawCache = [];

        // --- 2. è¦–çª—è¼‰å…¥å¾Œè‡ªå‹•è®€å–é è¨­è³‡æ–™ ---
        window.onload = function () {
            loadDefaultData();
        };

        async function loadDefaultData() {
            const statusText = document.getElementById('update-text');
            try {
                const res = await fetch('/api/local_data');
                if (!res.ok) throw new Error();
                const result = await res.json();
                renderCore(result);
                statusText.innerText = result.updated + " (å¾é è¨­å­˜æª”è¼‰å…¥)";
            } catch (e) {
                statusText.innerText = "å°šæœªæœ‰é è¨­å­˜æª”ï¼Œè«‹é»æ“Šæ›´æ–°æ•¸æ“š";
            }
        }

        // æ›´æ–°ä¸‹æ‹‰é¸å–®èˆ‡æ ¸å¿ƒå¿«å–
        function renderCore(result) {
            window.rawCache = result.data;
            const cities = [...new Set(window.rawCache.map(d => d.city))].filter(Boolean).sort();
            const types = [...new Set(window.rawCache.map(d => d.typename))].filter(Boolean).sort();
            document.getElementById('f-city').innerHTML = '<option value="">å…¨éƒ¨</option>' + cities.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('f-type').innerHTML = '<option value="">å…¨éƒ¨</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
            applyFilters();
        }

        // å¾å¾Œç«¯ API æ›´æ–°æœ€æ–°æ•¸æ“š
        async function fetchAndUpdate() {
            const btn = document.getElementById('btn-run');
            btn.disabled = true; btn.innerText = "é€£ç·šä¸­...";
            try {
                const res = await fetch('/api/update');
                const result = await res.json();
                renderCore(result);
                document.getElementById('update-text').innerText = result.updated;
            } catch (e) { alert("âŒ æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"); }
            finally { btn.disabled = false; btn.innerText = "ğŸ”„ æ›´æ–°æ•¸æ“š"; }
        }

        // åŸ·è¡Œç¯©é¸é‚è¼¯
        function applyFilters() {
            const cVal = document.getElementById('f-city').value;
            const tVal = document.getElementById('f-type').value;
            const sVal = document.getElementById('f-status').value;

            window.currentFiltered = window.rawCache.filter(item => {
                const matchC = !cVal || item.city === cVal;
                const matchT = !tVal || item.typename === tVal;
                const suspended = /æš«åœ|åœæ­¢|åœå ´|è¨»éŠ·|å±†æ»¿|å°å ´|å»¢æ­¢|æ’¤éŠ·|çµ‚æ­¢/.test(item.dumpname);
                const matchS = sVal === "all" || (sVal === "active" && !suspended) || (sVal === "suspended" && suspended);
                return matchC && matchT && matchS;
            });
            renderMarkers();
        }

        /**
         * 3. æ¸²æŸ“åœ°åœ–æ¨™è¨˜èˆ‡ä¸‹æ–¹ 10 æ¬„ä½è¡¨æ ¼
         */
        function renderMarkers() {
            markerGroup.clearLayers();
            const tbody = document.getElementById('data-list');
            tbody.innerHTML = '';
            document.getElementById('counter').innerText = `å…± ${window.currentFiltered.length} ç­†`;

            window.currentFiltered.forEach(d => {
                const suspended = /æš«åœ|åœæ­¢|åœå ´|è¨»éŠ·|å±†æ»¿|å°å ´|å»¢æ­¢|æ’¤éŠ·|çµ‚æ­¢/.test(d.dumpname || "");

                // å»ºç«‹ Popup å…§å®¹
                const popupContent = `
                <div style="min-width:220px; font-family: 'Microsoft JhengHei', sans-serif;">
                    <strong style="font-size:1.2em; color:#0d6efd;">${d.dumpname || "æœªå‘½å"}</strong><br/>
                    <div style="margin-top:8px; line-height:1.6;">
                        <b>ğŸ“ ç¸£å¸‚ï¼š</b> ${d.city || "ï¼"}<br/>
                        <b>ğŸ·ï¸ é¡å‹ï¼š</b> ${d.typename || "ï¼"}<br/>
                        <b>ğŸ†” æµå‘ç·¨è™Ÿï¼š</b> <code>${d.controlId || "ï¼"}</code><br/>
                        <b>ğŸ“… ç”³å ±æ—¥æœŸï¼š</b> ${d.applydate || "ï¼"}<br/>
                        <hr style="margin:8px 0; border:0; border-top:1px solid #eee;"/>
                        <b>ğŸ“Š å‰©é¤˜å¡«åŸ‹é‡ï¼š</b> ${Number(d.remain || 0).toLocaleString()} ã¥<br/>
                        <b>ğŸ“ˆ æ ¸å‡†å¡«åŸ‹é‡ï¼š</b> ${Number(d.maxbury || 0).toLocaleString()} ã¥<br/>
                        <b>ğŸ“ é¢ç©ï¼š</b> ${d.area || "0"} å…¬é ƒ<br/>
                        <hr style="margin:8px 0; border:0; border-top:1px solid #eee;"/>
                        <small class="text-muted">ç¶“ç·¯åº¦ï¼š${parseFloat(d.lat).toFixed(5)}, ${parseFloat(d.lng).toFixed(5)}</small>
                        ${suspended ? '<div style="margin-top:5px; color:#d63384; font-weight:bold; border:1px solid #d63384; text-align:center; border-radius:4px;">âš ï¸ ç‹€æ…‹ï¼šæš«åœ/åœæ­¢ä¸­</div>' : ""}
                    </div>
                </div>`;

                // å»ºç«‹æ¨™è¨˜
                const marker = L.marker([d.lat, d.lng], {
                    icon: suspended ? L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                    }) : new L.Icon.Default()
                }).addTo(markerGroup).bindPopup(popupContent);

                // å¡«å…¥è¡¨æ ¼
                const tr = document.createElement('tr');
                if (suspended) tr.className = 'suspended-row';
                tr.innerHTML = `
                <td><div class="fw-bold text-primary" style="min-width:150px;">${d.dumpname || "ï¼"}</div></td>
                <td>${d.city || "ï¼"}</td>
                <td><small>${d.typename || "ï¼"}</small></td>
                <td><code>${d.controlId || "ï¼"}</code></td>
                <td><small>${d.applydate || "ï¼"}</small></td>
                <td class="text-end fw-bold">${Number(d.remain || 0).toLocaleString()}</td>
                <td class="text-end">${Number(d.maxbury || 0).toLocaleString()}</td>
                <td class="text-end">${d.area || "0"}</td>
                <td><span class="badge ${suspended ? 'bg-danger' : 'bg-success'}">${suspended ? 'æš«åœ' : 'ç‡Ÿé‹'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" 
                        onclick="map.setView([${d.lat}, ${d.lng}], 15); markerGroup.eachLayer(l => {if(l.getLatLng && l.getLatLng().lat == ${d.lat} && l.getLatLng().lng == ${d.lng}) l.openPopup();});">
                        å®šä½
                    </button>
                </td>`;
                tbody.appendChild(tr);
            });

            if (window.currentFiltered.length > 0) {
                map.fitBounds(markerGroup.getBounds(), { padding: [50, 50], maxZoom: 13 });
            } else {
                map.setView([23.6, 120.9], 7);
            }
        }

        /**
         * 4. KML è™•ç†é‚è¼¯
         */
        // æ‰‹å‹•ç¸®æ”¾è‡³ KML ç¯„åœ
        function zoomToKml() {
            if (rangeGroup.getLayers().length === 0) {
                alert("è«‹å…ˆä¸Šå‚³ KML ç¯„åœæª”æ¡ˆ");
                return;
            }
            const bounds = rangeGroup.getBounds();
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15, animate: true });
            }
        }

        // KML ä¸Šå‚³ (ä¸ç¸®æ”¾ã€å¯¦ç·šã€å®Œæˆæç¤º)
        function handleKmlUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                rangeGroup.clearLayers();
                const kmlLayer = omnivore.kml.parse(e.target.result);
                kmlLayer.setStyle({ color: "#0055ff", weight: 4, fillOpacity: 0.1 }); // è—è‰²å¯¦ç·š

                kmlLayer.addTo(rangeGroup);
                setTimeout(() => { alert(`âœ… ç¯„åœé‚Šç•Œä¸Šå‚³å®Œæˆï¼\næª”æ¡ˆåç¨±ï¼š${file.name}`); }, 100);
                ;
            };
            reader.readAsText(file);
            event.target.value = ''; // é‡ç½® input
        }

        /**
         * 5. è³‡æ–™åŒ¯å‡ºèˆ‡æŠ½æ›é‚è¼¯
         */
        async function downloadFiltered(type) {
            if (!window.currentFiltered || !window.currentFiltered.length) return alert("è«‹å…ˆè¼‰å…¥æ•¸æ“š");
            try {
                const res = await fetch(`/api/export/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: window.currentFiltered })
                });
                if (!res.ok) {
                    const errorJson = await res.json();
                    alert("åŒ¯å‡ºå¤±æ•—ï¼š" + errorJson.error);
                    return;
                }
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `åœŸè³‡å ´è³‡æ–™_${new Date().getTime()}.${type === 'excel' ? 'xlsx' : 'kml'}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (err) { alert("ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰"); }
        }

        // æŠ½æ›ä¼ºæœå™¨ä¸Šçš„é è¨­ JSON
        async function uploadNewData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            try {
                const res = await fetch('/api/upload_default_json', { method: 'POST', body: formData });
                const result = await res.json();
                if (res.ok) {
                    renderCore(result);
                    document.getElementById('update-text').innerText = result.updated + " (å·²æ‰‹å‹•è¦†è“‹é è¨­å­˜æª”)";
                    alert("âœ… é è¨­è³‡æ–™åº« (data.json) å·²æˆåŠŸæ›´æ›ä¸¦é‡æ–°è¼‰å…¥ï¼");
                } else {
                    alert("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + result.error);
                }
            } catch (e) { alert("âŒ ç„¡æ³•é€£æ¥ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªå¾Œç«¯ API å·²å»ºç«‹"); }
            finally { event.target.value = ''; }
        }
    </script>
</body>

</html>