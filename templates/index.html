<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°åœŸçŸ³æ–¹è³‡æºåˆ†å¸ƒåœ°åœ–</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background-color: #f8f9fa;
            font-family: "Microsoft JhengHei", sans-serif;
        }

        header {
            background: white;
            border-bottom: 2px solid #eee;
            padding: 15px 0;
            margin-bottom: 20px;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #0d6efd;
        }

        .suspended-row {
            background-color: #fff5f5 !important;
            color: #b02a37;
        }

        footer {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px 0;
            text-align: center;
            margin-top: 30px;
        }

        /* è®“è¡¨æ ¼å…·å‚™å›æ‡‰å¼æ»¾å‹•ï¼ŒåŒæ™‚é™åˆ¶æœ€å¤§é«˜åº¦ */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
        }

        /* è¨­å®šè¡¨æ ¼åŸºæœ¬æ¨£å¼ */
        .table th,
        .table td {
            vertical-align: middle;
            padding: 12px 8px;
        }

        /* é—œéµï¼šè®“ç¬¬ä¸€æ¬„ï¼ˆå ´åï¼‰å¯ä»¥æ›è¡Œä¸¦é™åˆ¶å¯¬åº¦ */
        .table td:nth-child(1),
        .table th:nth-child(1) {
            white-space: normal !important;
            /* å…è¨±æ›è¡Œ */
            min-width: 180px;
            /* è¨­å®šæœ€å°å¯¬åº¦è§¸ç™¼æ›è¡Œ */
            max-width: 250px;
            word-break: break-all;
            /* é¿å…é•·è‹±æ–‡/æ•¸å­—æ’ç ´è¡¨æ ¼ */
        }

        /* å…¶ä»–æ¬„ä½å‰‡ä¿æŒä¸æ›è¡Œï¼Œä»¥ç¢ºä¿æ°´å¹³å»¶ä¼¸é¡¯ç¤ºå®Œæ•´è³‡è¨Š */
        .table td:not(:nth-child(1)),
        .table th:not(:nth-child(1)) {
            white-space: nowrap;
        }

        /* æ•¸å€¼æ¬„ä½å­—é«”ç¾åŒ–èˆ‡é å³å°é½Š */
        .text-end {
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
        }
    </style>
</head>

<body>

    <header>
        <div class="container">
            <h2 class="fw-bold mb-0">å…¨è‡ºåœŸçŸ³æ–¹è³‡æºå †ç½®è™•ç†å ´åœ°åœ–</h2>
        </div>
    </header>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div><span class="text-muted small">è³‡æ–™ç‹€æ…‹ï¼š<span id="update-text"
                        class="fw-bold text-primary">è®€å–ä¸­...</span></span></div>
            <div class="btn-group shadow-sm">
                <button onclick="fetchAndUpdate()" id="btn-run" class="btn btn-primary btn-sm px-3">ğŸ”„ æ›´æ–°æ•¸æ“š</button>
                <button onclick="downloadFiltered('excel')" class="btn btn-outline-primary btn-sm">ğŸ“¥ Excel</button>
                <button onclick="downloadFiltered('kml')" class="btn btn-outline-primary btn-sm">ğŸ“¥ KML</button>
                <button onclick="document.getElementById('kmlInput').click()" class="btn btn-outline-primary btn-sm">ğŸ“
                    ä¸Šå‚³ç¯„åœ</button>
                <button onclick="zoomToKml()" class="btn btn-outline-secondary btn-sm">ğŸ¯ ç¸®æ”¾è‡³ç¯„åœ</button>
                <input type="file" id="kmlInput" style="display: none;" accept=".kml" onchange="handleKmlUpload(event)">
            </div>
        </div>

        <div class="filter-section shadow-sm">
            <div class="row g-3">
                <div class="col-md-3"><label class="form-label small fw-bold">ç¸£å¸‚</label><select id="f-city"
                        class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="">å…¨éƒ¨</option>
                    </select></div>
                <div class="col-md-4"><label class="form-label small fw-bold">é¡å‹</label><select id="f-type"
                        class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="">å…¨éƒ¨</option>
                    </select></div>
                <div class="col-md-3"><label class="form-label small fw-bold">ç‹€æ…‹</label><select id="f-status"
                        class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="active">ç‡Ÿé‹ä¸­</option>
                        <option value="suspended">æš«åœ/åœæ­¢</option>
                    </select></div>
                <div class="col-md-2 d-flex align-items-end text-primary fw-bold pb-1" id="counter">å…± 0 ç­†</div>
            </div>
        </div>

        <div id="map" class="mb-4"></div>

        <div class="table-responsive shadow-sm bg-white rounded" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-hover align-middle mb-0" style="min-width: 1200px;">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>å ´å</th>
                        <th>ç¸£å¸‚</th>
                        <th>é¡å‹</th>
                        <th>æµå‘ç·¨è™Ÿ</th>
                        <th>ç”³å ±æ—¥æœŸ</th>
                        <th>å‰©é¤˜é‡(ã¥)</th>
                        <th>æ ¸å‡†é‡(ã¥)</th>
                        <th>é¢ç©(ha)</th>
                        <th>ç‹€æ…‹</th>
                        <th>å®šä½</th>
                    </tr>
                </thead>
                <tbody id="data-list"></tbody>
            </table>
        </div>
    </div>

    <footer>
        <div class="container">Â© 2026 ä¸­èˆˆå·¥ç¨‹é¡§å•è‚¡ä»½æœ‰é™å…¬å¸åœ’è·¯éƒ¨</div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>

    <script>
        // --- 1. åˆå§‹åŒ–åº•åœ–æ§åˆ¶ ---
        const osm = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' });
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri Satellite'
        });

        const map = L.map('map', { center: [23.6, 120.9], zoom: 7, layers: [osm] });
        let markerGroup = L.featureGroup().addTo(map);
        let rangeGroup = L.featureGroup().addTo(map);

        // åœ–å±¤åˆ‡æ›é¸å–®
        L.control.layers({ "ğŸ—ºï¸ é›»å­åœ°åœ–": osm, "ğŸ›°ï¸ èˆªç…§åœ–å±¤": satellite }, { "ğŸ“ åœŸè³‡å ´": markerGroup, "ğŸ“ ç¯„åœå€": rangeGroup }).addTo(map);

        window.rawCache = [];

        // --- 2. é è¨­è‡ªå‹•è¼‰å…¥åŠŸèƒ½ ---
        window.onload = function () {
            loadDefaultData();
        };

        async function loadDefaultData() {
            const statusText = document.getElementById('update-text');
            try {
                const res = await fetch('/api/local_data');
                if (!res.ok) throw new Error();
                const result = await res.json();
                renderCore(result);
                statusText.innerText = result.updated + " (å¾é è¨­å­˜æª”è¼‰å…¥)";
            } catch (e) {
                statusText.innerText = "å°šæœªæœ‰é è¨­å­˜æª”ï¼Œè«‹é»æ“Šæ›´æ–°æ•¸æ“š";
            }
        }

        function renderCore(result) {
            window.rawCache = result.data;
            const cities = [...new Set(window.rawCache.map(d => d.city))].filter(Boolean).sort();
            const types = [...new Set(window.rawCache.map(d => d.typename))].filter(Boolean).sort();
            document.getElementById('f-city').innerHTML = '<option value="">å…¨éƒ¨</option>' + cities.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('f-type').innerHTML = '<option value="">å…¨éƒ¨</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
            applyFilters();
        }

        async function fetchAndUpdate() {
            const btn = document.getElementById('btn-run');
            btn.disabled = true; btn.innerText = "é€£ç·šä¸­...";
            try {
                const res = await fetch('/api/update');
                const result = await res.json();
                renderCore(result);
                document.getElementById('update-text').innerText = result.updated;
            } catch (e) { alert("âŒ æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"); }
            finally { btn.disabled = false; btn.innerText = "ğŸ”„ æ›´æ–°æ•¸æ“š"; }
        }

        function applyFilters() {
            const cVal = document.getElementById('f-city').value;
            const tVal = document.getElementById('f-type').value;
            const sVal = document.getElementById('f-status').value;

            window.currentFiltered = window.rawCache.filter(item => {
                const matchC = !cVal || item.city === cVal;
                const matchT = !tVal || item.typename === tVal;
                const suspended = /æš«åœ|åœæ­¢|åœå ´|çµ‚æ­¢/.test(item.dumpname);
                const matchS = sVal === "all" || (sVal === "active" && !suspended) || (sVal === "suspended" && suspended);
                return matchC && matchT && matchS;
            });

            // --- æ ¹æ“šç¯©é¸ç¸®æ”¾åœ°åœ– ---
            renderMarkers();
        }

        // ... (ä¹‹å‰çš„åº•åœ–åˆå§‹åŒ–ä¿æŒä¸è®Š)

        // ä¿®æ”¹ 1: è®“æ¨™è¨˜æ¸²æŸ“å®Œå¾Œï¼Œè‡ªå‹•æ ¹æ“šã€Œç›®å‰é¡¯ç¤ºçš„æ¨™è¨˜ã€ç¸®æ”¾
        /**
 * 1. æ¸²æŸ“åœ°åœ–æ¨™è¨˜èˆ‡ä¸‹æ–¹å®Œæ•´è³‡è¨Šè¡¨æ ¼
 */
        function renderMarkers() {
            // 1. æ¸…é™¤ç¾æœ‰æ¨™è¨˜èˆ‡è¡¨æ ¼å…§å®¹
            markerGroup.clearLayers();
            const tbody = document.getElementById('data-list');
            tbody.innerHTML = '';
            document.getElementById('counter').innerText = `å…± ${window.currentFiltered.length} ç­†`;

            // 2. éæ­·ç¯©é¸å¾Œçš„è³‡æ–™
            window.currentFiltered.forEach(d => {
                // åˆ¤æ–·æ˜¯å¦ç‚ºæš«åœç‹€æ…‹
                const suspended = /æš«åœ|åœæ­¢|åœå ´|çµ‚æ­¢/.test(d.dumpname || "");

                // --- å»ºç«‹åœ°åœ–æ¨™è¨˜èˆ‡è©³ç´° Popup ---
                const popupContent = `
            <div style="min-width:220px; font-family: 'Microsoft JhengHei', sans-serif;">
                <strong style="font-size:1.2em; color:#0d6efd;">${d.dumpname || "æœªå‘½å"}</strong><br/>
                <div style="margin-top:8px; line-height:1.6;">
                    <b>ğŸ“ ç¸£å¸‚ï¼š</b> ${d.city || "ï¼"}<br/>
                    <b>ğŸ·ï¸ é¡å‹ï¼š</b> ${d.typename || "ï¼"}<br/>
                    <b>ğŸ†” æµå‘ç·¨è™Ÿï¼š</b> <code>${d.controlId || "ï¼"}</code><br/>
                    <b>ğŸ“… ç”³å ±æ—¥æœŸï¼š</b> ${d.applydate || "ï¼"}<br/>
                    <hr style="margin:8px 0; border:0; border-top:1px solid #eee;"/>
                    <b>ğŸ“Š B1~B7 å‰©é¤˜å¡«åŸ‹é‡ï¼š</b> ${Number(d.remain || 0).toLocaleString()} ã¥<br/>
                    <b>ğŸ“ˆ B1~B7 æ ¸å‡†å¡«åŸ‹é‡ï¼š</b> ${Number(d.maxbury || 0).toLocaleString()} ã¥<br/>
                    <b>ğŸ“ é¢ç©ï¼š</b> ${d.area || "0"} å…¬é ƒ<br/>
                    <hr style="margin:8px 0; border:0; border-top:1px solid #eee;"/>
                    <small class="text-muted">ç¶“ç·¯åº¦ï¼š${parseFloat(d.lat).toFixed(5)}, ${parseFloat(d.lng).toFixed(5)}</small>
                    ${suspended ? '<div style="margin-top:5px; color:#d63384; font-weight:bold; border:1px solid #d63384; text-align:center; border-radius:4px;">âš ï¸ ç‹€æ…‹ï¼šæš«åœ/åœæ­¢ä¸­</div>' : ""}
                </div>
            </div>
        `;

                const marker = L.marker([d.lat, d.lng], {
                    icon: suspended ? L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                    }) : new L.Icon.Default()
                }).addTo(markerGroup).bindPopup(popupContent);

                // 3. å¡«å…¥ä¸‹æ–¹è¡¨æ ¼å®Œæ•´æ¬„ä½
                const tr = document.createElement('tr');
                if (suspended) tr.className = 'suspended-row';

                tr.innerHTML = `
            <td><div class="fw-bold text-primary" style="min-width:150px;">${d.dumpname || "ï¼"}</div></td>
            <td>${d.city || "ï¼"}</td>
            <td><small>${d.typename || "ï¼"}</small></td>
            <td><code>${d.controlId || "ï¼"}</code></td>
            <td><small>${d.applydate || "ï¼"}</small></td>
            <td class="text-end fw-bold">${Number(d.remain || 0).toLocaleString()}</td>
            <td class="text-end">${Number(d.maxbury || 0).toLocaleString()}</td>
            <td class="text-end">${d.area || "0"}</td>
            <td>
                <span class="badge ${suspended ? 'bg-danger' : 'bg-success'}">
                    ${suspended ? 'æš«åœ' : 'ç‡Ÿé‹'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" 
                        onclick="map.setView([${d.lat}, ${d.lng}], 15); markerGroup.eachLayer(l => {if(l.getLatLng && l.getLatLng().lat == ${d.lat} && l.getLatLng().lng == ${d.lng}) l.openPopup();});">
                    å®šä½
                </button>
            </td>
        `;
                tbody.appendChild(tr);
            });

            // 4. è‡ªå‹•ç¸®æ”¾é‚è¼¯
            if (window.currentFiltered.length > 0) {
                map.fitBounds(markerGroup.getBounds(), { padding: [50, 50], maxZoom: 13 });
            } else {
                map.setView([23.6, 120.9], 7);
            }
        }

        /**
 * æ–°å¢åŠŸèƒ½ï¼šæ‰‹å‹•ç¸®æ”¾è‡³ KML ç¯„åœ
 */
        function zoomToKml() {
            // æª¢æŸ¥ç›®å‰åœ°åœ–ä¸Šæ˜¯å¦æœ‰è¼‰å…¥ KML ç¯„åœ
            if (rangeGroup.getLayers().length === 0) {
                alert("è«‹å…ˆä¸Šå‚³ KML ç¯„åœæª”æ¡ˆ");
                return;
            }

            // å–å¾—ç¯„åœé‚Šç•Œ
            const bounds = rangeGroup.getBounds();

            if (bounds.isValid()) {
                // åŸ·è¡Œç¸®æ”¾
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 15,
                    animate: true
                });
            }
        }

        /**
         * 2. KML ä¸Šå‚³è™•ç†èˆ‡è‡ªå‹•ç¸®æ”¾
         */
        function handleKmlUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                // 1. æ¸…é™¤èˆŠæœ‰çš„ç¯„åœåœ–å±¤
                rangeGroup.clearLayers();

                // 2. è§£æ KML æ–‡å­—å…§å®¹ (æ”¯æ´ LineString åº§æ¨™çµæ§‹) [cite: 1, 6]
                const kmlLayer = omnivore.kml.parse(e.target.result);

                // 3. è¨­å®šç¯„åœæ¨£å¼ (è—è‰²è™›ç·šé‚Šæ¡†) [cite: 7]
                kmlLayer.setStyle({
                    color: "#0055ff",
                    weight: 4,
                    fillOpacity: 0.1,
                    //dashArray: '8, 8'
                });

                // 4. ç›´æ¥åŠ å…¥åœ°åœ–ï¼Œä¸åŸ·è¡Œç¸®æ”¾èˆ‡æç¤º
                kmlLayer.addTo(rangeGroup);
                // è·³å‡ºå®Œæˆæ¡† (ä½¿ç”¨å»¶é²ç¢ºä¿èƒŒæ™¯æ¸²æŸ“é †åˆ©)
                setTimeout(() => {
                    alert(`âœ… ç¯„åœé‚Šç•Œä¸Šå‚³å®Œæˆï¼\næª”æ¡ˆåç¨±ï¼š${file.name}`);
                }, 100);
            };

            reader.readAsText(file);

            // é‡ç½® input ä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥é‡æ–°ä¸Šå‚³
            event.target.value = '';
        }

        async function downloadFiltered(type) {
            if (!window.currentFiltered || !window.currentFiltered.length) return alert("è«‹å…ˆè¼‰å…¥æ•¸æ“š");

            try {
                const res = await fetch(`/api/export/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: window.currentFiltered })
                });

                // æ ¸å¿ƒä¿®æ­£ï¼šå¦‚æœå¾Œç«¯å ±éŒ¯ï¼Œä¸è¦ç•¶æˆæª”æ¡ˆä¸‹è¼‰ï¼Œè€Œæ˜¯é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                if (!res.ok) {
                    const errorJson = await res.json();
                    alert("åŒ¯å‡ºå¤±æ•—ï¼š" + errorJson.error);
                    return;
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // è¨­å®šæ­£ç¢ºçš„ä¸‹è¼‰æª”å
                a.download = `åœŸè³‡å ´è³‡æ–™_${new Date().getTime()}.${type === 'excel' ? 'xlsx' : 'kml'}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (err) {
                alert("ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰");
            }
        }
    </script>
</body>

</html>